const b=(r,t,e)=>r<t?t:r>e?e:r,f=r=>r<0?0:r,g=(r,t)=>{let e=0;for(let s=0;s<r.length;s++)e+=t(r[s]);return e},m=(r,t)=>r.length===1?t(r[0]):g(r,t)/r.length,v=r=>{let t;const e=()=>(t=void 0,r());return[()=>t??=requestAnimationFrame(e),()=>t!==void 0&&(cancelAnimationFrame(t),t=void 0)]};class E extends HTMLElement{static observedAttributes=["scale","min-scale","max-scale","offset-x","offset-y"];#s=1;get scale(){return this.#s}set scale(t){this.#s!==t&&(this.#r("scale",this.#s=t=b(t,this.#t,this.#e)),this.#u.style.transform=`scale(${t})`)}#t=.1;get minScale(){return this.#t}set minScale(t){this.#t!==t&&t>0&&(this.#r("min-scale",this.#t=t),this.#s<t&&(this.scale=t))}#e=100;get maxScale(){return this.#e}set maxScale(t){this.#e!==t&&t>0&&(this.#r("max-scale",this.#e=t),this.#s>t&&(this.scale=t))}#n=0;get offsetX(){return this.#n}set offsetX(t){this.setOffset(t,this.#i)}#i=0;get offsetY(){return this.#i}set offsetY(t){this.setOffset(this.#n,t)}#a=0;#c=0;#o;#h;#u;#d;constructor(){super();const t=this.attachShadow({mode:"open"});t.innerHTML="<div part=container><div part=top-left></div><slot part=content></slot></div>",this.#o=t.firstElementChild,this.#h=this.#o.firstElementChild,this.#u=this.#h.nextElementSibling;{let e=1;const[s]=v(()=>e=1);this.#d=()=>{s(),e=0},this.addEventListener("scroll",()=>{if(e){const n=this.#v()[0].transformPoint({x:this.#a-this.scrollLeft,y:this.#c-this.scrollTop});this.#r("offset-x",this.#n=n.x),this.#r("offset-y",this.#i=n.y)}})}}#l=1;#r(t,e){this.#l=0,this.setAttribute(t,e),this.#l=1}attributeChangedCallback(t,e,s){this.#l&&e!==s&&(this[t.replace(/-([a-z])/g,(n,o)=>o.toUpperCase())]=+s)}connectedCallback(){this.setAttribute("scale",this.#s),this.setAttribute("min-scale",this.#t),this.setAttribute("max-scale",this.#e)}#m="";#f=[new DOMMatrixReadOnly,new DOMMatrixReadOnly];#v(){let t="";for(let e=this;e;e=e.parentElement){const s=getComputedStyle(e).transform;s&&s!=="none"&&(t=`${s} ${t}`)}if(this.#m!==t){const e=new DOMMatrix(t);e.e=e.f=0,this.#m=t,this.#f=[DOMMatrixReadOnly.fromMatrix(e),DOMMatrixReadOnly.fromMatrix(e.inverse())]}return this.#f}setOffset(t,e){if(this.#n===t&&this.#i===e)return;this.#r("offset-x",this.#n=t),this.#r("offset-y",this.#i=e);const{x:s,y:n}=this.#v()[1].transformPoint({x:t,y:e}),o=this.#o.style;o.margin=`${this.#c=f(n)}px 0 0 ${this.#a=f(s)}px`,o.width=`${s<0?this.clientWidth-s:0}px`,o.height=`${n<0?this.clientHeight-n:0}px`,this.#d(),this.scrollTo(f(-s),f(-n))}zoom(t,e,s){const n=this.#s,o=b(n*t,this.#t,this.#e);if(o===n)return;const a=o/n-1,h=this.#h.getBoundingClientRect();this.scale=o,this.setOffset(this.#n+a*(h.x-e),this.#i+a*(h.y-s))}}const p={passive:!1},y=typeof ontouchend<"u";class L extends E{static observedAttributes=[...super.observedAttributes,"event-source","pan","pinch-zoom"];#s=this;get eventSource(){return this.#s}set eventSource(t){t??=this,this.eventSource!==t&&(this.#s=t,t===window?this.setAttribute("event-source","window"):this.removeAttribute("event-source"),this.#i())}#t=!1;get pan(){return this.#t}set pan(t){t=!!t,this.#t!==t&&((this.#t=t)?this.setAttribute("pan",""):this.removeAttribute("pan"))}#e=!1;get pinchZoom(){return this.#e}set pinchZoom(t){t=!!t,this.#e!==t&&((this.#e=t)?this.setAttribute("pinch-zoom",""):this.removeAttribute("pinch-zoom"))}attributeChangedCallback(t,e,s){t==="pan"?this.pan=s!==null:t==="pinch-zoom"?this.pinchZoom=s!==null:t==="event-source"?this.eventSource=s==="window"?window:this:super.attributeChangedCallback(t,e,s)}constructor(){super(),this.#i()}#n=()=>{};#i(){this.#n();const t=this.#s;if(y){let e={x:0,y:0,d:0},s=[];const[n,o]=v(()=>{const i=m(s,d=>d.x),l=m(s,d=>d.y),c=e.d&&m(s,d=>d.d);c&&this.zoom(c/e.d,i,l),this.setOffset(this.offsetX+i-e.x,this.offsetY+l-e.y),s=[],e={x:i,y:l,d:c}}),a=({touches:i})=>({x:m(i,l=>l.clientX),y:m(i,l=>l.clientY),d:i.length>1?Math.hypot(i[0].clientX-i[1].clientX,i[0].clientY-i[1].clientY):0}),h=i=>{o(),s=[],i.touches.length!==0&&(e=a(i))},u=i=>{(i.touches.length===1?this.#t:this.#e)&&(i.preventDefault(),s.push(a(i)),n())};t.addEventListener("touchstart",h),t.addEventListener("touchend",h),t.addEventListener("touchmove",u,p),this.#n=()=>{t.removeEventListener("touchstart",h),t.removeEventListener("touchend",h),t.removeEventListener("touchmove",u,p)}}else{let e;{let s=1,n,o;const[a]=v(()=>{this.zoom(s,n,o),s=1});e=h=>{this.#e&&h.ctrlKey&&(h.preventDefault(),s*=.98**h.deltaY,{clientX:n,clientY:o}=h,a())}}{let s,n,o,a;const[h]=v(()=>{this.setOffset(this.offsetX+o-s,this.offsetY+a-n),s=o,n=a}),u=c=>{c.preventDefault(),{clientX:o,clientY:a}=c,h()},i=c=>{this.#t&&c.button===0&&({clientX:s,clientY:n}=c,addEventListener("pointermove",u))},l=()=>removeEventListener("pointermove",u);t.addEventListener("wheel",e,p),t.addEventListener("pointerdown",i),t.addEventListener("pointerup",l),t.addEventListener("pointercancel",l),this.#n=()=>{t.removeEventListener("wheel",e,p),t.removeEventListener("pointerdown",i),t.removeEventListener("pointerup",l),t.removeEventListener("pointercancel",l)}}}}}customElements.define("gesture-frame",L);export{L as GestureFrame};
